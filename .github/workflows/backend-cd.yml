name: CD-Deploy Backend

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - backend/**


jobs:
   deploy:
     runs-on: ubuntu-latest
     services:
       postgres:
         image: postgres:14.1
         env:
           POSTGRES_USER: postgres
           POSTGRES_PASSWORD: 123
           POSTGRES_DB: fullstack
         ports:
           - 5332:5432
         options: >-
           --health-cmd pg_ready
           --health-interval 10s
           --health-timeout 5s
           --health-retries 5

     defaults:
       run:
         working-directory: ./backend

     steps:
       - uses: actions/checkout@v3
       - uses: actions/setup-java@v3
         with:
           distribution: 'temurin'
           java-version: '17'
           cache: 'maven'
       - name: Login to docker hub
         uses: docker/login-action@v2
         with:
           username: ${{secrets.DOCKERHUB_USERNAME}}
           password: ${{secrets.DOCKERHUB_ACCESS_TOKEN}}
       - name: Set build number
         id: build-number
         run: echo "BUILD_NUMBER=$(date  '+%d.%m.%Y.%H.%M.%S')" >> $GITHUB_OUTPUT

       - name: Build package push with Maven
         run: mvn -ntp -B verify -Docker.image.tag=${{steps.build-number.outputs.BUILD_NUMBER}} jib:build

       - name: Update Dockerrun.aws.json api image tag with new build number
         run: |
           echo "Dockerrun.aws.json before updating tag"
           cat ../Dockerrun.aws.json
           sed -i -E 's_(amigoscode/amigoscode-api:)([^"]*)_\1'${{steps.build-number.outputs.BUILD_NUMBER}}'_' ../Dockerrun.aws.json
           echo "Dockerrun.aws.json after updating tag"
           cat ../Dockerrun.aws.json









